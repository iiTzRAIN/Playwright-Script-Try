const puppeteer = require('puppeteer-core');

// 1. CONFIGURATION
// Pull secrets from GitHub Environment Variables
const USERNAME = process.env.LOGIN_USERNAME;
const PASSWORD = process.env.LOGIN_PASSWORD;

// We use the full URL from secrets (recommended) or fallback to constructing it if you only set a TOKEN secret
const TOKEN = process.env.BROWSERLESS_TOKEN; 
const BROWSERLESS_URL = process.env.BROWSERLESS_URL || `wss://production-sfo.browserless.io?token=${TOKEN}`;

// 2. HELPER: SESSION CLEANUP
async function closeSession(browser, page) {
  try {
    if (page) {
      console.log("Cleaning up session data...");
      await page.evaluate(() => {
        localStorage.clear();
        sessionStorage.clear();
      });
      // Clear cookies
      const client = await page.target().createCDPSession();
      await client.send('Network.clearBrowserCookies');
    }
    if (browser) await browser.close();
  } catch (err) {
    console.error("Cleanup warning:", err.message);
    if (browser) await browser.close();
  }
}

// 3. MAIN EXECUTION
(async () => {
  // Validation
  if (!USERNAME || !PASSWORD) {
    console.error("‚ùå Error: Missing credentials. Check your GitHub Secrets (LOGIN_USERNAME, LOGIN_PASSWORD).");
    process.exit(1); 
  }

  if (!BROWSERLESS_URL || BROWSERLESS_URL.includes("undefined")) {
    console.error("‚ùå Error: Missing BROWSERLESS_URL or BROWSERLESS_TOKEN.");
    process.exit(1);
  }

  let browser;
  let page;

  try {
    console.log(`üöÄ Connecting to Browserless...`);
    browser = await puppeteer.connect({ 
        browserWSEndpoint: BROWSERLESS_URL,
    });
    
    page = await browser.newPage();
    console.log(`‚úÖ Connected. Navigating to login page...`);

    // Helper: Fill Text Inputs
    async function fillInput(selectorId, value) {
      if (!value) return;
      await page.waitForSelector(selectorId, { timeout: 10000 });
      await page.click(selectorId, { clickCount: 3 });
      await page.type(selectorId, String(value), { delay: 30 });
    }

    // --- Login Flow ---
    await page.goto('https://jaccess.jclonline.my/JACCESS/login.php', { waitUntil: 'networkidle2', timeout: 60000 });
    
    console.log("‚úçÔ∏è  Filling credentials...");
    await fillInput('#login-userid-field', USERNAME);
    await fillInput('#passwordorig', PASSWORD);
    
    const submitSelector = '#JURIS_LOGIN_SUBMIT';
    await page.waitForSelector(submitSelector, { visible: true, timeout: 10000 });
    
    console.log("kiÔ∏è  Clicking Login...");
    await Promise.all([
        page.click(submitSelector),
        page.waitForNavigation({ waitUntil: 'networkidle2', timeout: 60000 })
    ]);

    // Check for success indicator (optional but recommended)
    console.log(`üéâ Login Successful for user: ${USERNAME}`);

    // --- Logout Flow ---
    console.log("üëã Initiating Logout...");
    const accountDropdown = '#control-account';
    await page.waitForSelector(accountDropdown, { visible: true, timeout: 10000 });
    await page.click(accountDropdown);
    
    const logoutSelector = 'a[href*="do_logout.php"]';
    await page.waitForSelector(logoutSelector, { visible: true, timeout: 5000 });
    
    await Promise.all([
      page.click(logoutSelector),
      page.waitForNavigation({ waitUntil: 'networkidle2', timeout: 30000 })
    ]);

    console.log("‚úÖ Logout Complete.");
    
    // Explicitly exit with success code
    process.exit(0);

  } catch (error) {
    console.error(`‚ùå Automation Failed: ${error.message}`);
    
    // Ensure the GitHub Action knows this failed
    process.exit(1);
    
  } finally {
    await closeSession(browser, page);
  }
})();
